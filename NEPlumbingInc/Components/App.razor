<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="NEPlumbingInc.styles.css" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <!-- Browser theme color for Safari and Chrome -->
    <meta name="theme-color" content="#0066CC">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <HeadOutlet />
</head>

<body>
    <Routes />
    <script src="_framework/blazor.web.js"></script>
    <script>
        // Blazor circuit handler for reconnection
        Blazor.addEventListener('unhandledError', event => {
            console.error('Blazor error:', event.reason);
        });

        // Theme restoration is handled by MainLayout (interactive routing).

        // Function to update dark mode attribute
        window.UpdateDarkModeAttribute = function(isDarkMode) {
            document.documentElement.setAttribute('data-dark-mode', isDarkMode ? 'true' : 'false');
            // Also update the main wrapper div for Razor components
            const wrapper = document.querySelector('[data-dark-mode]');
            if (wrapper && wrapper !== document.documentElement) {
                wrapper.setAttribute('data-dark-mode', isDarkMode ? 'true' : 'false');
            }
        };

        // Function to get system dark mode preference
        window.GetSystemDarkModePreference = function() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches;
        };

        // Clean up corrupted localStorage entries
        window.CleanupCorruptedStorage = function() {
            try {
                // Remove known corrupted keys
                localStorage.removeItem('med>i__field');
                
                // Remove any keys with invalid characters
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('>') || key.includes('<') || key.includes('field'))) {
                        localStorage.removeItem(key);
                    }
                }
            } catch (e) {
                console.error('Error cleaning localStorage:', e);
            }
        };
        
        // Run cleanup on page load
        CleanupCorruptedStorage();
        
        // Restore dark mode setting on page load
        window.RestoreDarkModeSetting = function() {
            try {
                const savedDarkMode = localStorage.getItem('darkMode');
                let isDarkMode;
                
                if (savedDarkMode !== null) {
                    // User has manually set a preference - use it
                    isDarkMode = savedDarkMode === 'true';
                } else {
                    // No user preference - check system preference
                    isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
                }
                
                document.documentElement.setAttribute('data-dark-mode', isDarkMode ? 'true' : 'false');
                // Also update any Razor wrapper divs
                const wrapper = document.querySelector('[data-dark-mode]');
                if (wrapper && wrapper !== document.documentElement) {
                    wrapper.setAttribute('data-dark-mode', isDarkMode ? 'true' : 'false');
                }
            } catch (e) {
                console.error('Error restoring dark mode:', e);
            }
        };
        
        // Apply dark mode on initial page load
        RestoreDarkModeSetting();
    </script>
</body>

</html>
