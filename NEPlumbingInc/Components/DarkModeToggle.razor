@inject DarkModeService DarkModeService
@inject IJSRuntime JS
@rendermode InteractiveServer

<button class="dark-mode-toggle" @onclick="ToggleDarkMode" type="button" title="Toggle dark mode">
    <i class="fas @(DarkModeService.IsDarkMode ? "fa-sun" : "fa-moon")"></i>
</button>

<style>
    /* Dark mode toggle button */
    .dark-mode-toggle {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 1.5rem;
        padding: 0.5rem;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: auto;
        position: relative;
        z-index: 11;
    }

    .dark-mode-toggle:hover {
        transform: scale(1.1);
    }

    .dark-mode-toggle:focus {
        outline: 2px solid rgba(255, 255, 255, 0.5);
        outline-offset: 2px;
    }
</style>

@code {
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Clear any corrupted localStorage data
            await JS.InvokeVoidAsync("localStorage.removeItem", "med>i__field");
            
            // Restore dark mode setting from localStorage
            var savedDarkMode = await JS.InvokeAsync<string>("localStorage.getItem", "darkMode");
            if (savedDarkMode != null && bool.TryParse(savedDarkMode, out bool isDarkMode))
            {
                DarkModeService.IsDarkMode = isDarkMode;
                // Apply the saved setting to the page
                await JS.InvokeVoidAsync("UpdateDarkModeAttribute", isDarkMode);
            }
        }
        catch { }
    }

    private async Task ToggleDarkMode()
    {
        DarkModeService.IsDarkMode = !DarkModeService.IsDarkMode;
        try
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "darkMode", DarkModeService.IsDarkMode.ToString().ToLower());
        }
        catch
        {
            // If JS interop fails, still toggle the mode locally
        }
        
        // Update the data-dark-mode attribute on the page
        try
        {
            await JS.InvokeVoidAsync("UpdateDarkModeAttribute", DarkModeService.IsDarkMode);
        }
        catch
        {
            // Fallback - StateHasChanged should still work
        }
        
        StateHasChanged();
    }
}

