@inherits LayoutComponentBase
@inject ThemeService ThemeService
@inject IColorSettingsService ColorSettingsService
@implements IAsyncDisposable

<PageTitle>N.E. Plumbing Inc.</PageTitle>

<style>
    :root {
        --bs-body-bg: #ffffff;
        --bs-body-color: #212529;
        --primary-color: @(colorSettings?.PrimaryColor ?? "#0066CC");
        --secondary-color: @(colorSettings?.SecondaryColor ?? "#005299");
        --accent-color: @(colorSettings?.AccentColor ?? "#003d7a");
        --text-color: @(colorSettings?.TextColor ?? "#212529");
        --light-bg-color: @(colorSettings?.LightBgColor ?? "#f8f9fa");
        --hero-badge-color: @(colorSettings?.HeroBadgeColor ?? "#0056b3");
        --button-color: @(colorSettings?.ButtonColor ?? "#0066CC");
        --bs-border-color: #dee2e6;
        --bs-code-color: #e83e8c;
        --bs-heading-color: inherit;
        --bs-link-color: #0066CC;
        --bs-link-hover-color: #0052a3;
    }

    [data-dark-mode="true"] {
        --bs-body-bg: #1e1e1e;
        --bs-body-color: #d4d4d4;
        --bs-border-color: #3e3e42;
        --bs-link-color: #569cd6;
        --bs-link-hover-color: #9cdcfe;
    }

    [data-dark-mode="true"],
    [data-dark-mode="true"] html,
    [data-dark-mode="true"] body,
    [data-dark-mode="true"] main,
    [data-dark-mode="true"] .min-vh-100,
    [data-dark-mode="true"] section,
    [data-dark-mode="true"] article {
        background-color: #1e1e1e !important;
        color: #d4d4d4;
    }

    /* Remove any light backgrounds */
    [data-dark-mode="true"] [class*="bg-light"],
    [data-dark-mode="true"] [class*="bg-white"] {
        background-color: #252526 !important;
    }

    /* Dark mode - Navigation */
    [data-dark-mode="true"] .navbar,
    [data-dark-mode="true"] .navbar-dark {
        background-color: #252526 !important;
    }

    [data-dark-mode="true"] .nav-link {
        color: #d4d4d4 !important;
    }

    [data-dark-mode="true"] .nav-link:hover {
        color: #9cdcfe !important;
    }

    /* Dark mode - Content */
    [data-dark-mode="true"] main {
        background-color: #1e1e1e;
        color: #d4d4d4;
    }

    [data-dark-mode="true"] .container,
    [data-dark-mode="true"] .container-fluid {
        background-color: transparent;
    }

    /* Dark mode - Cards and Panels */
    [data-dark-mode="true"] .card {
        background-color: #252526;
        border-color: #3e3e42;
        color: #d4d4d4;
    }

    [data-dark-mode="true"] .card-header {
        background-color: #2d2d30;
        border-color: #3e3e42;
        color: #d4d4d4;
    }

    [data-dark-mode="true"] .card-body {
        background-color: #252526;
        color: #d4d4d4;
    }

    [data-dark-mode="true"] .card-footer {
        background-color: #2d2d30;
        border-color: #3e3e42;
    }

    /* Dark mode - Modals */
    [data-dark-mode="true"] .modal-content {
        background-color: #252526;
        border-color: #3e3e42;
        color: #d4d4d4;
    }

    [data-dark-mode="true"] .modal-header {
        background-color: #2d2d30;
        border-color: #3e3e42;
    }

    [data-dark-mode="true"] .modal-footer {
        background-color: #2d2d30;
        border-color: #3e3e42;
    }

    /* Dark mode - Forms */
    [data-dark-mode="true"] .form-control,
    [data-dark-mode="true"] .form-select {
        background-color: #3c3c3c;
        border-color: #3e3e42;
        color: #d4d4d4;
    }

    [data-dark-mode="true"] .form-control:focus,
    [data-dark-mode="true"] .form-select:focus {
        background-color: #3c3c3c;
        border-color: #569cd6;
        color: #d4d4d4;
        box-shadow: 0 0 0 0.2rem rgba(86, 156, 214, 0.25);
    }

    [data-dark-mode="true"] .form-label {
        color: #d4d4d4;
    }

    [data-dark-mode="true"] .input-group-text {
        background-color: #3c3c3c;
        border-color: #3e3e42;
        color: #d4d4d4;
    }

    /* Dark mode - Buttons */
    [data-dark-mode="true"] .btn-primary {
        background-color: #0e639c;
        border-color: #0e639c;
        color: #d4d4d4;
    }

    [data-dark-mode="true"] .btn-primary:hover {
        background-color: #1177bb;
        border-color: #1177bb;
    }

    [data-dark-mode="true"] .btn-secondary {
        background-color: #3e3e42;
        border-color: #3e3e42;
        color: #d4d4d4;
    }

    [data-dark-mode="true"] .btn-secondary:hover {
        background-color: #4e4e54;
        border-color: #4e4e54;
    }

    [data-dark-mode="true"] .btn-outline-light {
        color: #d4d4d4;
        border-color: #d4d4d4;
    }

    [data-dark-mode="true"] .btn-outline-light:hover {
        background-color: #d4d4d4;
        color: #1e1e1e;
    }

    [data-dark-mode="true"] .btn-outline-primary {
        color: #569cd6;
        border-color: #569cd6;
    }

    [data-dark-mode="true"] .btn-outline-primary:hover {
        background-color: #569cd6;
        border-color: #569cd6;
        color: #1e1e1e;
    }

    /* Dark mode - Tables */
    [data-dark-mode="true"] .table {
        color: #d4d4d4;
        border-color: #3e3e42;
    }

    [data-dark-mode="true"] .table-striped > tbody > tr:nth-of-type(odd) {
        background-color: #2d2d30;
    }

    [data-dark-mode="true"] .table-hover > tbody > tr:hover {
        background-color: #3c3c3c;
    }

    [data-dark-mode="true"] .table-bordered,
    [data-dark-mode="true"] .table-bordered > :not(caption) > * {
        border-color: #3e3e42;
    }

    /* Dark mode - Accordions */
    [data-dark-mode="true"] .accordion-button {
        background-color: #3c3c3c;
        color: #d4d4d4;
        border-color: #3e3e42;
    }

    [data-dark-mode="true"] .accordion-button:not(.collapsed) {
        background-color: #4e4e54;
        color: #d4d4d4;
        border-color: #3e3e42;
    }

    [data-dark-mode="true"] .accordion-button:focus {
        border-color: #569cd6;
        box-shadow: 0 0 0 0.25rem rgba(86, 156, 214, 0.25);
    }

    [data-dark-mode="true"] .accordion-body {
        background-color: #252526;
        border-color: #3e3e42;
    }

    /* Dark mode - Lists and Text */
    [data-dark-mode="true"] h1,
    [data-dark-mode="true"] h2,
    [data-dark-mode="true"] h3,
    [data-dark-mode="true"] h4,
    [data-dark-mode="true"] h5,
    [data-dark-mode="true"] h6 {
        color: #d4d4d4;
    }

    [data-dark-mode="true"] p {
        color: #d4d4d4;
    }

    [data-dark-mode="true"] .text-muted {
        color: #858585 !important;
    }

    [data-dark-mode="true"] .text-secondary {
        color: #858585 !important;
    }

    /* Dark mode - Links */
    [data-dark-mode="true"] a {
        color: #569cd6;
    }

    [data-dark-mode="true"] a:hover {
        color: #9cdcfe;
    }

    /* Dark mode - Borders and Dividers */
    [data-dark-mode="true"] hr {
        border-color: #3e3e42;
    }

    [data-dark-mode="true"] .border {
        border-color: #3e3e42 !important;
    }

    /* Dark mode - Alerts */
    [data-dark-mode="true"] .alert {
        background-color: #2d2d30;
        border-color: #3e3e42;
        color: #d4d4d4;
    }

    [data-dark-mode="true"] .alert-info {
        background-color: #1e3a4d;
        border-color: #0e639c;
        color: #9cdcfe;
    }

    [data-dark-mode="true"] .alert-warning {
        background-color: #4a3a1a;
        border-color: #ce9178;
        color: #dcdcaa;
    }

    [data-dark-mode="true"] .alert-danger {
        background-color: #4a1f1f;
        border-color: #f48771;
        color: #f48771;
    }

    [data-dark-mode="true"] .alert-success {
        background-color: #1a4d2a;
        border-color: #4ec9b0;
        color: #4ec9b0;
    }

    /* Dark mode - Badges */
    [data-dark-mode="true"] .badge {
        background-color: #4a7ba7;
        color: #e0f0ff;
        font-weight: 500;
    }

    [data-dark-mode="true"] .badge-primary {
        background-color: #0e639c;
        color: #e0f0ff;
    }

    [data-dark-mode="true"] .badge-secondary {
        background-color: #5a7a8a;
        color: #e0f0ff;
    }

    [data-dark-mode="true"] .badge-success {
        background-color: #2d7a3a;
        color: #a0ffa0;
    }

    [data-dark-mode="true"] .badge-danger {
        background-color: #7a3a2a;
        color: #ffa0a0;
    }

    [data-dark-mode="true"] .badge-warning {
        background-color: #7a6a2a;
        color: #ffe0a0;
    }

    [data-dark-mode="true"] .badge-info {
        background-color: #2a6a7a;
        color: #a0e0ff;
    }

    [data-dark-mode="true"] .badge-light {
        background-color: #5a7a8a;
        color: #e0f0ff;
    }

    [data-dark-mode="true"] .badge-dark {
        background-color: #3a4a5a;
        color: #d4d4d4;
    }

    /* Dark mode - Footer */
    [data-dark-mode="true"] footer {
        background-color: #252526 !important;
        color: #d4d4d4;
    }

    [data-dark-mode="true"] footer a {
        color: #569cd6;
    }

    [data-dark-mode="true"] footer a:hover {
        color: #9cdcfe;
    }

    [data-dark-mode="true"] .border-secondary {
        border-color: #3e3e42 !important;
    }

    .navbar-brand {
        font-size: 1.5rem;
        font-weight: bold;
    }

    .nav-link {
        font-size: 1rem;
    }

    /* Ensure navbar displays properly on all browsers */
    header.navbar {
        display: flex;
        flex-wrap: wrap;
        width: 100%;
    }
</style>

<div class="min-vh-100 d-flex flex-column" data-dark-mode="@ThemeService.IsDarkMode.ToString().ToLower()">
    <header class="navbar navbar-expand-lg navbar-dark w-100" style="background-color: var(--primary-color); padding: 0.5rem 1rem;">
        <!-- Company Name -->
        <a class="navbar-brand flex-shrink-0" href="">N.E. Plumbing Inc.</a>

        <!-- Center Nav Links -->
        <div class="d-flex navbar-nav-center ms-3">
            <NavLink class="nav-link text-white me-3" href="" Match="NavLinkMatch.All">
                <span class="oi oi-home" aria-hidden="true"></span> Home
            </NavLink>
            <NavLink class="nav-link text-white me-3" href="services">
                <span class="oi oi-plus" aria-hidden="true"></span> Services
            </NavLink>
        </div>

        <!-- Right Side Login/Logout & Dark Mode -->
        <div class="d-flex navbar-controls ms-auto">
            <DarkModeToggle />
            <AuthorizeView Roles="Admin">
                <Authorized Context="auth">
                    <div class="d-flex align-items-center gap-2">
                        <NavLink class="nav-link text-white" href="admin-dashboard">
                            <span class="oi oi-account-logout" aria-hidden="true"></span> @auth.User.Identity?.Name's dashboard
                        </NavLink>
                        <NavLink class="nav-link text-white" href="/auth/logout">
                            <span class="oi oi-account-logout" aria-hidden="true"></span> Logout
                        </NavLink>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <NavLink class="nav-link text-white" href="/account/login">
                        <span class="oi oi-account-login" aria-hidden="true"></span> Admin Login
                    </NavLink>
                </NotAuthorized>
            </AuthorizeView>
        </div>
    </header>

    <main class="container my-4 flex-grow-1">
        @Body
    </main>

    <footer class="text-white py-4 mt-auto" style="background-color: var(--primary-color);">
        <div class="container">
            <div class="row text-center text-md-start">
                <!-- About -->
                <div class="col-md-4 mb-3">
                    <h5>About Us</h5>
                    <p class="mb-0">N.E. Plumbing Inc. brings 20+ years of experience in residential, commercial, and luxury
                        plumbing. We’re proud to serve all of Utah with expert service and professionalism.</p>
                </div>

                <!-- Now Hiring -->
                <div class="col-md-4 mb-3">
                    <h5>Now Hiring</h5>
                    <p class="mb-1">We're looking for skilled plumbers to join our team!</p>
                    <a href="/messages" class="btn btn-outline-light btn-sm">Apply Now</a>
                </div>

                <!-- Connect -->
                <div class="col-md-4 mb-3">
                    <h5>Connect With Us</h5>

                    <p class="mb-1">
                        <a href="https://www.instagram.com/neplumbinginc" target="_blank" rel="noopener noreferrer"
                            class="text-white text-decoration-none">
                            <i class="fab fa-instagram fa-lg me-2"></i>Instagram
                        </a>
                    </p>

                    <p class="mb-1">
                        <a href="tel:8016413246" class="text-white text-decoration-none">
                            <i class="fas fa-phone fa-sm me-2"></i>(801) 641-3246
                        </a>
                    </p>

                    <p class="mb-0">
                        <a href="mailto:neplumbinginc@gmail.com" class="text-white text-decoration-none">
                            <i class="fas fa-envelope fa-sm me-2"></i>neplumbinginc@gmail.com
                        </a>
                    </p>

                    <!-- Added Contact Us Link -->
                    <p class="mt-3">
                        <a href="/messages" class="btn btn-outline-light btn-sm">Contact Us</a>
                    </p>
                </div>
            </div>

            <hr class="border-secondary" />

            <div class="text-center small">
                &copy; @(DateTime.Now.Year) N.E. Plumbing Inc. All rights reserved.
            </div>
        </div>
    </footer>
</div>

@code {
    private ColorSettings? colorSettings;
    private bool initialized = false;

    protected override async Task OnInitializedAsync()
    {
        // Load color settings (no JS interop)
        colorSettings = await ColorSettingsService.GetColorSettingsAsync();
        ThemeService.OnChange += OnThemeChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Always restore dark mode setting on every render (for navigation)
        string? darkModeValue = await JS.InvokeAsync<string?>("localStorage.getItem", "darkMode");
        bool isDarkMode;
        
        if (darkModeValue != null)
        {
            // User has a saved preference
            isDarkMode = darkModeValue == "true";
        }
        else
        {
            // No saved preference - check system preference
            isDarkMode = await JS.InvokeAsync<bool>("GetSystemDarkModePreference");
        }
        
        if (firstRender && !initialized)
        {
            initialized = true;
            ThemeService.Initialize(isDarkMode);
        }
        else if (!firstRender)
        {
            // On navigation, update the service if it changed
            ThemeService.IsDarkMode = isDarkMode;
        }
        
        // Always apply the dark mode attribute
        await JS.InvokeVoidAsync("UpdateDarkModeAttribute", isDarkMode);
    }

    private void OnThemeChanged()
    {
        // Apply the dark mode attribute whenever dark mode changes
        _ = JS.InvokeVoidAsync("UpdateDarkModeAttribute", ThemeService.IsDarkMode);
        StateHasChanged();
    }

    [Inject]
    private IJSRuntime JS { get; set; } = null!;

    ValueTask IAsyncDisposable.DisposeAsync()
    {
        ThemeService.OnChange -= OnThemeChanged;
        return ValueTask.CompletedTask;
    }
}